---
layout: post
title: Pulsar 基础介绍
categories: [pulsar]
description: Pulsar 介绍
keywords: pulsar
---

# 什么是Pulsar

Pulsar 是一个用于服务器到服务器的消息系统，具有多租户、高性能等优势。 Pulsar 最初由 [Yahoo](http://yahoo.github.io/) 开发，目前由 [Apache 软件基金会](https://www.apache.org/)管理。

Pulsar 的关键特性如下：

- Pulsar 的单个实例原生支持多个集群，可[跨机房](https://pulsar.apache.org/docs/zh-CN/administration-geo)在集群间无缝地完成消息复制。
- 极低的发布延迟和端到端延迟。
- 可无缝扩展到超过一百万个 topic。
- 简单的[客户端 API](https://pulsar.apache.org/docs/zh-CN/concepts-clients)，支持 [Java](https://pulsar.apache.org/docs/zh-CN/client-libraries-java)、[Go](https://pulsar.apache.org/docs/zh-CN/client-libraries-go)、[Python](https://pulsar.apache.org/docs/zh-CN/client-libraries-python) 和 [C++](https://pulsar.apache.org/docs/zh-CN/client-libraries-cpp)。
- 支持多种[ topic 订阅模式](https://pulsar.apache.org/docs/zh-CN/concepts-messaging#subscription-modes)（[独占订阅](https://pulsar.apache.org/docs/zh-CN/concepts-messaging#exclusive)、[共享订阅](https://pulsar.apache.org/docs/zh-CN/concepts-messaging#shared)、[故障转移订阅](https://pulsar.apache.org/docs/zh-CN/concepts-messaging#failover)）。
- 通过 [Apache BookKeeper](http://bookkeeper.apache.org/) 提供的[持久化消息存储机制](https://pulsar.apache.org/docs/zh-CN/concepts-architecture-overview#persistent-storage)保证消息传递 。
- 由轻量级的 serverless 计算框架 [Pulsar Functions](https://pulsar.apache.org/docs/zh-CN/functions-overview) 实现流原生的数据处理。
- 基于 Pulsar Functions 的 serverless connector 框架 [Pulsar IO](https://pulsar.apache.org/docs/zh-CN/io-overview) 使得数据更易移入、移出 Apache Pulsar。
- [分层式存储](https://pulsar.apache.org/docs/zh-CN/concepts-tiered-storage)可在数据陈旧时，将数据从热存储卸载到冷/长期存储（如S3、GCS）中

# Pulsar 架构

![pulsar-架构2](/images/posts/pulsar-架构2.png)

![pulsar-架构1](/images/posts/pulsar-架构1.png)

单个 Pulsar 集群由以下三部分组成：

- 一个或者多个 broker 负责处理和负载均衡 producer 发出的消息，并将这些消息分派给 consumer；Broker 与 Pulsar 配置存储交互来处理相应的任务，并将消息存储在 BookKeeper 实例中（又称 bookies）；Broker 依赖 ZooKeeper 集群处理特定的任务，等等。
- 包含一个或多个 bookie 的 BookKeeper 集群负责消息的[持久化存储](https://pulsar.apache.org/docs/zh-CN/concepts-architecture-overview/#persistent-storage)。
- 一个Zookeeper集群，用来处理多个Pulsar集群之间的协调任务

## Pulsar Broker

1.一个或者多个 broker 负责处理和负载均衡 producer 发出的消息，并将这些消息分派给 consumer；Broker 与 Pulsar 配置存储交互来处理相应的任务，并将消息存储在 BookKeeper 实例中（又称 bookies）；Broker 依赖 ZooKeeper 集群处理特定的任务，等等。

2.Pulsar Broker是 无状态的,其他的 *broker* 可以很快接管 *Topic,不*会涉及 *Topic* 数据的拷贝,在Topic 级别拥有一个Leader Broker, 称之为Topic owner，针对该Topic所有的读写都经过该Broker 完成

### Dispatcher 

一个调度分发器, 它是异步的TCP服务器，通过自定义 [二进制协议](https://pulsar.apache.org/docs/zh-CN/develop-binary-protocol)应用于所有相关的数据传输

### Global Replication 

跨地域跨集群复制消息的功能

![pulsar-relocation](/images/posts/pulsar-relocation.png)

在此图中，每当**P1**，**P2**和**P3**生产者将消息分别发布到**Cluster-A**，**Cluster-B**和**Cluster-C**群集上的**T1**主题时，这些消息就会立即在群集之间复制。复制消息后，**C1**和**C2**使用者可以使用它们各自群集中的消息。

没有地理复制，**C1**和**C2**使用者将无法使用**P3产生**者发布的消息

当在Pulsar Topic上生成消息时，消息首先保留在本地群集中，然后异步转发到远程群集在正常情况下，如果不存在连接问题，则在将消息分发到本地使用者的同时立即复制消息。通常，远程区域之间的网络[往返时间](https://en.wikipedia.org/wiki/Round-trip_delay_time)（RTT）定义了端到端传递延迟

在上述示例中，**T1**主题在三个群集**Cluster-A**，**Cluster-B**和**Cluster-C**之间复制。

三个群集中任何一个群集中生成的所有消息都将传递到其他群集中的所有订阅。在这种情况下，**C1**和**C2**使用者接收**P1**，**P2**和**P3产生**者发布的所有消息。仍保证按生产者顺序订购。



### Managed Ledger 

Pulsar中 基于 BookieKeeper 做的Managed Ledger.

鉴于Bookkeeper Ledger 提供 a single log 抽象，ManagedLedger它代表单个topic 的存储层。保证只有一个Pulsar Broker向ledger读写，它提供Single-Writer-Single-Reader的语义。ManagedLedger也进行记录消费的偏移。跟踪每个Topic所包含的Ledgers和Fragments。这个元数据存储在Zookeeper中

在内部，一个 ManangedLedger 使用多个BookKeeper Ledgers来存储数据。拥有多个Ledger有两个原因：

1. 发生故障后，原有的某个Ledger不能再写了，需要创建一个新的。
2. 当所有Cusors都使用完分类帐中包含的消息时，可以将其删除。允许Ledger的定期滚动,像log日志那样.

### Load Balancer

负载均衡管理器，主要是根据pulsar broker 的CPU, 内存，网卡流量等指标来判定是否超载，超载后进行卸载Topic, 将Topic owner 转移到负载低的broker上

