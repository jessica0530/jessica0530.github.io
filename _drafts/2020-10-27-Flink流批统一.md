---
layout: post
title: Flink流批统一
categories: [flink]
description: Flink
keywords: flink
---


Count Distinct

count(distinct item_id)

一个共享 DateState

JoinState

上游有UK,且JoinKey 包含UK (JK,ValueState<Row>)

上游有UK,但JoinKey不包含UK (JK,MapState<UK,ROW>)
上游没有UK  <JK,ListState<Row>>

无JoinKey


批计算

容错 (Batch Shuffle mode)

资源模型 -提高资源利用率

Hive集成 -Meta/

SQL 优化 -丰富完善的Rules

SQL 支持 -Rules


Batch mode/pipeline mode

Batch mode

容错好,可以单点恢复
调度好,不管多少资源都可以运行
性能差,中间数据要落盘,强烈建议开启压缩


Pipeline Mode

容错差,只能全局重来

调度差,你得保证有足够的资源
性能好,Pipeline 执行,完全复用Stream，复用流控反压等功能


Session Mode


批排序算子  

Normalized Key +多线程

最大值是16字节 是截取前面的16字节(不是整个key排序)

Write Thread  SortThread SpillThread Merge Thread

默认用 Cost来选取是否两阶段 


Join

HybridHashJoin      VS    SortMergeJoin

（内存不够 多余的 spill）

Batch已经达到 一个 production的 相比Hive 有7倍的性能


流作业需要全部调度起来

批作业

HashJoin

内部先构建Index

再消费一个数据

从Concurrent-Group的调度

Blocking的方式 网络的shuffle

